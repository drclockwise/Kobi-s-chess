<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kobi's memory chess</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fff4f7;color:#2b1b24}
  .wrap{max-width:760px;margin:0 auto;padding:22px}
  .card{background:#ffc0cb;border:1px solid #f2a8b8;border-radius:20px;padding:18px;box-shadow:0 14px 40px rgba(43,27,36,.18);color:#2b1b24}
  h1{font-size:22px;margin:0 0 6px}
  .meta{opacity:.85;margin:0 0 14px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  a.btn,button{border:0;border-radius:14px;padding:12px 14px;font-weight:650;cursor:pointer;text-decoration:none;display:inline-block}
  a.btn{background:#2b1b24;color:#fff}
  button{background:#7b2c43;color:#fff}
  .ghost{background:#ffffffaa;border:1px solid #f2a8b8;color:#2b1b24}
  .box{margin-top:14px;padding:14px;border-radius:14px;background:#fff7f9;border:1px dashed #e48fa5;color:#2b1b24}
  .small{font-size:13px;opacity:.78;margin-top:12px}
  code{background:#2b1b24;padding:2px 6px;border-radius:8px;color:#fff}
  .err{margin-top:14px;padding:12px;border-radius:14px;background:#2a1020;border:1px solid #6a2a44;display:none;white-space:pre-wrap;color:#ffd6e5}
</style>


  <!-- Zorgt dat data.js eerst geladen is -->
  <script src="data.js" defer></script>
  <script defer>
    // ------- SAFE STORAGE (werkt ook als localStorage faalt) -------
    const MEM = { game: null, usedByGame: {} };

    function safeGet(key){ try { return localStorage.getItem(key); } catch { return null; } }
    function safeSet(key,val){ try { localStorage.setItem(key,val); return true; } catch { return false; } }

    function uuid(){
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return (Date.now().toString(36) + Math.random().toString(36).slice(2));
    }

    function getGame(){
      const raw = safeGet("mc_game");
      if (raw) return JSON.parse(raw);
      if (!MEM.game) MEM.game = { id: uuid(), startedAt: Date.now() };
      safeSet("mc_game", JSON.stringify(MEM.game));
      return MEM.game;
    }
    function resetGame(){
      const g = { id: uuid(), startedAt: Date.now() };
      MEM.game = g;
      MEM.usedByGame[g.id] = new Set();
      safeSet("mc_game", JSON.stringify(g));
      return g;
    }
    function getUsed(gameId){
      const raw = safeGet("mc_used_" + gameId);
      if (raw) return new Set(JSON.parse(raw));
      if (!MEM.usedByGame[gameId]) MEM.usedByGame[gameId] = new Set();
      return MEM.usedByGame[gameId];
    }
    function setUsed(gameId, usedSet){
      MEM.usedByGame[gameId] = usedSet;
      safeSet("mc_used_" + gameId, JSON.stringify([...usedSet]));
    }

    function randInt(n){
      if (window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(1);
        crypto.getRandomValues(a);
        return a[0] % n;
      }
      return Math.floor(Math.random() * n);
    }

    function buildPool(piece){
      const typePool = (window.TYPE_CHALLENGES && window.TYPE_CHALLENGES[piece.type]) ? window.TYPE_CHALLENGES[piece.type] : [];
      const globalPool = window.GLOBAL_CHALLENGES || [];
      return [...new Set([...typePool, ...globalPool])];
    }

    function drawChallenge(piece){
      const game = getGame();
      const used = getUsed(game.id);
      const pool = buildPool(piece);

      if (!pool.length) return { pick: "‚ö†Ô∏è Geen challenges gevonden. Zet GLOBAL_CHALLENGES of TYPE_CHALLENGES in data.js.", game };

      let available = pool.filter(c => !used.has(c));
      if (!available.length){
        used.clear();
        available = pool.slice();
      }

      const pick = available[randInt(available.length)];
      used.add(pick);
      setUsed(game.id, used);
      return { pick, game };
    }

    function showError(msg){
      const el = document.getElementById("err");
      el.style.display = "block";
      el.textContent = msg;
    }

    // ------- INIT -------
    window.addEventListener("DOMContentLoaded", () => {
      try{
        const params = new URLSearchParams(location.search);
        const id = (params.get("id") || "").toUpperCase();

        const titleEl = document.getElementById("title");
        const metaEl = document.getElementById("meta");
        const photosBtn = document.getElementById("photosBtn");
        const challengeText = document.getElementById("challengeText");
        const rerollBtn = document.getElementById("rerollBtn");
        const newGameBtn = document.getElementById("newGameBtn");
        const debugEl = document.getElementById("debug");

        // debug info
        debugEl.textContent =
          `id=${id || "(geen)"} | data.js loaded=${!!window.CHESS} | challenges(global)=${(window.GLOBAL_CHALLENGES||[]).length}`;

        if (!id){
          titleEl.textContent = "Scan een stuk";
          metaEl.innerHTML = `Voeg <code>?id=WK</code> toe aan de URL (later doet NFC dit automatisch).`;
          photosBtn.style.display = "none";
          rerollBtn.style.display = "none";
          newGameBtn.style.display = "none";
          return;
        }

        if (!window.CHESS){
          showError("data.js is niet geladen (of heeft een syntax error). Check: /Kobischess/data.js");
          return;
        }

        const piece = window.CHESS[id];
        if (!piece){
          titleEl.textContent = "Onbekend stuk";
          metaEl.innerHTML = `Geen entry voor <code>${id}</code> in data.js`;
          photosBtn.style.display = "none";
          rerollBtn.style.display = "none";
          return;
        }

        titleEl.textContent = `${piece.title} (${id})`;
        metaEl.textContent = `Type: ${piece.type}`;
        photosBtn.href = piece.photos; // <‚Äî dit is waarom jouw knop nu ‚Äú#‚Äù blijft als JS crasht

        function refresh(){
          const { pick, game } = drawChallenge(piece);
          challengeText.textContent = pick;
          const d = new Date(game.startedAt);
          document.getElementById("gameInfo").textContent = `Partij gestart: ${d.toLocaleString("nl-NL")}`;
        }

        rerollBtn.addEventListener("click", refresh);
        newGameBtn.addEventListener("click", () => { resetGame(); refresh(); });

        refresh();
      } catch(e){
        showError("JS error:\n" + (e && e.stack ? e.stack : e));
      }
    });
  </script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">Kobi's memory chess</h1>
      <p id="meta" class="meta"></p>

      <div class="btns">
        <a id="photosBtn" class="btn" href="#" target="_blank" rel="noopener">üì∏ Bekijk herinnering</a>
        <button id="rerollBtn" class="ghost">üé≤ Andere challenge</button>
        <button id="newGameBtn" class="ghost">‚ôªÔ∏è Nieuwe partij</button>
      </div>

      <div class="box">
        <div style="opacity:.85;margin-bottom:8px">Challenge:</div>
        <div id="challengeText" style="font-size:18px;font-weight:650;line-height:1.25"></div>
        <div id="gameInfo" class="small"></div>
      </div>

      <div class="small">Gefeliciteerd met je verjaardag maatje! Elk schaakstuk bevat unieke herinneringen en is gekoppeld aan andere challenges‚Äù.</div>

      <div id="err" class="err"></div>
     
    </div>
  </div>
</body>
</html>
